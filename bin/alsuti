#!/bin/bash

if [ -z "$ALSUTI_API_KEY" ]; then
  echo "You must set an ALSUTI_API_KEY environment variable."
  exit 1
fi

if [ -z "$ALSUTI_ENDPOINT" ]; then
  echo "You must set an ALSUTI_ENDPOINT environment variable."
  exit 1
fi

while [[ $# > 1 ]]
do
key="$1"

case $key in
    -p|--password)
    password="$2"
    shift # past argument
    ;;
	*)
    ;;
esac
shift # past argument or value
done

if [ -z "$1" ]; then
  file="/tmp/$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 5 | head -n 1).txt"
  echo "$(cat)" > $file
  echo
else 
  file=$1
fi

if [ "$password" ]; then
  echo "Encrypting $file"
  efile=`konfuzi $file $password`
  echo Uploading $file
  curl --form "fileupload=@$efile" --form api_key=$ALSUTI_API_KEY --form encrypted=true $ALSUTI_ENDPOINT/upload
else 
  echo Uploading $file
  curl --form "fileupload=@$file" --form api_key=$ALSUTI_API_KEY $ALSUTI_ENDPOINT/upload
fi

echo ''
