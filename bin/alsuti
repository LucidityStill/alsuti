#!/bin/bash

if [ -z "$ALSUTI_API_KEY" ]; then
  echo "You must set an ALSUTI_API_KEY environment variable."
  exit 1
fi

if [ -z "$ALSUTI_ENDPOINT" ]; then
  echo "You must set an ALSUTI_ENDPOINT environment variable."
  exit 1
fi

while [[ $# > 0 ]]
do
key="$1"
case $key in
    -p|--password)
      password="$2"
      shift # past argument
      ;;
    -e|--encrypt)
      password=$(cat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | fold -w 16 | head -n 1)
      echo "Generated password: $password" 
      ;;
	*)
      file="$@"
      ;;
esac
shift # past argument or value
done

if [ -z "$file" ]; then
  file="/tmp/$(cat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | fold -w 5 | head -n 1).txt"
  echo "Enter input to upload (press ctrl+d when you're done):"
  echo "$(cat)" > $file
  echo
fi

is_image=$(file -i $file | grep -ic image)
if [ $is_image -eq 1 ]; then
  echo "Stripping EXIF data"
  convert "$file" -strip "$file"
fi

if [ "$password" ]; then
  echo "Encrypting $file"
  efile=`konfuzi "$file" $password`
  echo Uploading $file
  out=`curl --form "fileupload=@$efile" --form api_key=$ALSUTI_API_KEY --form encrypted=true $ALSUTI_ENDPOINT/upload`
else 
  echo Uploading $1
  out=`curl --form "fileupload=@$file" --form api_key=$ALSUTI_API_KEY $ALSUTI_ENDPOINT/upload`
fi

if hash xclip 2>/dev/null; then
  echo $out | xclip -selection clipboard
fi
echo $out
echo ''
